name: OKR to M3U8 and Deploy V2

on:
  workflow_dispatch:
    inputs:
      link:
        description: 'ID video OK.ru hoặc URL'
        required: true
      name:
        description: 'Tên file (slug) để deploy'
        required: true
      token:
        description: 'Cloudflare API Token'
        required: true
      projectName:
        description: 'Tên project Pages'
        required: true
      accountId:
        description: 'Cloudflare Account ID'
        required: true
      time2:
        description: 'Số giây cắt từ đầu (ví dụ: 120)'
        required: false
      time3:
        description: 'Số giây cắt từ cuối (ví dụ: 50)'
        required: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg aria2 jq
          python3 -m pip install --upgrade pip
          pip install --upgrade yt-dlp

      - name: Download Video from OK.ru
        id: download
        run: |
          RAW_URL="${{ github.event.inputs.link }}"
          # Chuyển ID số thành URL nếu cần
          if [[ "$RAW_URL" =~ ^[0-9]+$ ]]; then
            URL="https://ok.ru/video/$RAW_URL"
          else
            URL="$RAW_URL"
          fi
          
          echo "Downloading from: $URL"
          
          # Tải video chất lượng tốt nhất (ưu tiên 1080p/720p)
          # Sử dụng aria2 để tăng tốc tải
          yt-dlp \
            -f "bv*[height<=1080]+ba/b[height<=1080] / best" \
            --merge-output-format mp4 \
            --downloader aria2c \
            --downloader-args "aria2c:--max-connection-per-server=16 --split=16" \
            --no-check-certificate \
            -o "input_video.mp4" \
            "$URL"
          
          # Kiểm tra file tồn tại và size > 0
          if [ ! -s input_video.mp4 ]; then
            echo "Download failed or file empty"
            exit 1
          fi

      - name: Cut Video (Smart Trim)
        run: |
          T2="${{ github.event.inputs.time2 }}"
          T3="${{ github.event.inputs.time3 }}"
          
          if [ -n "$T2" ] || [ -n "$T3" ]; then
            echo "Processing trim..."
            
            # Lấy tổng thời lượng video
            DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 input_video.mp4)
            
            # Gán giá trị mặc định nếu rỗng
            START=${T2:-0}
            OFFSET_END=${T3:-0}
            
            # Tính toán điểm kết thúc (Tổng - T3)
            END_POINT=$(awk "BEGIN {print $DURATION - $OFFSET_END}")
            
            echo "Original Duration: $DURATION"
            echo "Trimming from $START to $END_POINT"
            
            ffmpeg -i input_video.mp4 \
              -ss "$START" \
              -to "$END_POINT" \
              -avoid_negative_ts make_zero \
              -c copy processed_video.mp4
              
            mv processed_video.mp4 input_video.mp4
            echo "Trim completed."
          else
            echo "No trim timestamps provided, skipping."
          fi

      - name: Convert to HLS fMP4 (Segments as PNG)
        run: |
          mkdir -p output
          NAME="${{ github.event.inputs.name }}"
          
          # Giải thích các tham số FFmpeg:
          # -map 0:v:0 -map 0:a? : Lấy video đầu tiên, lấy audio nếu có (không lỗi nếu ko có audio)
          # -c:v copy : Giữ nguyên bitrate/chất lượng video (không encode lại - cực nhanh)
          # -hls_fmp4_init_filename : Đặt tên file init (quan trọng nhất của fMP4) thành .png
          # -hls_segment_filename : Đặt tên các mảnh segment thành .png
          
          ffmpeg -i input_video.mp4 \
            -map 0:v:0 -map 0:a? \
            -c:v copy \
            -c:a aac -b:a 128k \
            -f hls \
            -start_number 10001 \
            -hls_time 6 \
            -hls_list_size 0 \
            -hls_segment_type fmp4 \
            -hls_fmp4_init_filename "${NAME}-index.png" \
            -hls_segment_filename "output/${NAME}-index%d.png" \
            "output/${NAME}.m3u8"
          
          # Kiểm tra xem file m3u8 có được tạo không
          if [ ! -f "output/${NAME}.m3u8" ]; then
            echo "FFmpeg failed to create m3u8"
            exit 1
          fi

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.accountId }}
          projectName: ${{ github.event.inputs.projectName }}
          directory: ./output
          branch: ${{ github.event.inputs.name }}

      - name: Callback status
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" == "success" ]; then
            TYPE="ok"
          else
            TYPE="error"
          fi
          curl -G "https://cp.ssplay.net/cf.php" \
            --data-urlencode "type=$TYPE" \
            --data-urlencode "key=${{ github.event.inputs.projectName }}" \
            --data-urlencode "slug=${{ github.event.inputs.name }}"
